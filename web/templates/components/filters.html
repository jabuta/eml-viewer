{{define "filters"}}
<div class="bg-gray-50 rounded-lg p-4 space-y-4" id="filter-panel">
    <div class="flex items-center justify-between">
        <h3 class="text-sm font-semibold text-gray-700">Filters</h3>
        <button
            onclick="clearFilters()"
            class="text-sm text-blue-600 hover:text-blue-700 font-medium"
        >
            Clear All
        </button>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
        <!-- Sender Filter -->
        <div>
            <label
                for="filter-sender"
                class="block text-sm font-medium text-gray-700 mb-1"
                >Sender</label
            >
            <input
                type="text"
                id="filter-sender"
                name="sender"
                placeholder="email@example.com"
                list="sender-list"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"
                hx-get="/search"
                hx-trigger="keyup changed delay:500ms, change"
                hx-target="#email-list"
                hx-include="[name='q'], [name='sender'], [name='recipient'], [name='has_attachments'], [name='date_from'], [name='date_to']"
                hx-indicator="#search-spinner"
            />
            <datalist id="sender-list">
                <!-- Populated lazily via JavaScript -->
            </datalist>
        </div>

        <!-- Recipient Filter -->
        <div>
            <label
                for="filter-recipient"
                class="block text-sm font-medium text-gray-700 mb-1"
                >Recipient</label
            >
            <input
                type="text"
                id="filter-recipient"
                name="recipient"
                placeholder="email@example.com"
                list="recipient-list"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"
                hx-get="/search"
                hx-trigger="keyup changed delay:500ms, change"
                hx-target="#email-list"
                hx-include="[name='q'], [name='sender'], [name='recipient'], [name='has_attachments'], [name='date_from'], [name='date_to']"
                hx-indicator="#search-spinner"
            />
            <datalist id="recipient-list">
                <!-- Populated lazily via JavaScript -->
            </datalist>
        </div>

        <!-- Date From Filter -->
        <div>
            <label
                for="filter-date-from"
                class="block text-sm font-medium text-gray-700 mb-1"
                >From Date</label
            >
            <input
                type="date"
                id="filter-date-from"
                name="date_from"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"
                hx-get="/search"
                hx-trigger="change"
                hx-target="#email-list"
                hx-include="[name='q'], [name='sender'], [name='recipient'], [name='has_attachments'], [name='date_from'], [name='date_to']"
                hx-indicator="#search-spinner"
            />
        </div>

        <!-- Date To Filter -->
        <div>
            <label
                for="filter-date-to"
                class="block text-sm font-medium text-gray-700 mb-1"
                >To Date</label
            >
            <input
                type="date"
                id="filter-date-to"
                name="date_to"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"
                hx-get="/search"
                hx-trigger="change"
                hx-target="#email-list"
                hx-include="[name='q'], [name='sender'], [name='recipient'], [name='has_attachments'], [name='date_from'], [name='date_to']"
                hx-indicator="#search-spinner"
            />
        </div>

        <!-- Has Attachments Filter -->
        <div class="flex items-end">
            <label class="flex items-center space-x-2 cursor-pointer">
                <input
                    type="checkbox"
                    id="filter-has-attachments"
                    name="has_attachments"
                    value="true"
                    class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-2 focus:ring-blue-500"
                    hx-get="/search"
                    hx-trigger="change"
                    hx-target="#email-list"
                    hx-include="[name='q'], [name='sender'], [name='has_attachments'], [name='date_from'], [name='date_to']"
                    hx-indicator="#search-spinner"
                />
                <span class="text-sm font-medium text-gray-700"
                    >Has Attachments</span
                >
            </label>
        </div>
    </div>

    <!-- Active Filters Display -->
    <div id="active-filters" class="flex flex-wrap gap-2 mt-2"></div>
</div>

<script>
    // Lazy-load autocomplete data only when needed
    let autocompleteLoaded = false;

    function loadAutocompleteData() {
        if (autocompleteLoaded) return;

        // Load senders
        fetch("/api/autocomplete/senders?limit=100")
            .then((response) => response.json())
            .then((senders) => {
                const datalist = document.getElementById("sender-list");
                senders.forEach((sender) => {
                    const option = document.createElement("option");
                    option.value = sender;
                    datalist.appendChild(option);
                });
            })
            .catch((err) => console.error("Failed to load senders:", err));

        // Load recipients
        fetch("/api/autocomplete/recipients?limit=100")
            .then((response) => response.json())
            .then((recipients) => {
                const datalist = document.getElementById("recipient-list");
                recipients.forEach((recipient) => {
                    const option = document.createElement("option");
                    option.value = recipient;
                    datalist.appendChild(option);
                });
            })
            .catch((err) => console.error("Failed to load recipients:", err));

        autocompleteLoaded = true;
    }

    // Load autocomplete data when filter panel becomes visible
    const observer = new MutationObserver((mutations) => {
        mutations.forEach((mutation) => {
            if (
                mutation.target.classList &&
                !mutation.target.classList.contains("hidden")
            ) {
                loadAutocompleteData();
            }
        });
    });

    // Start observing the filter panel's parent for visibility changes
    document.addEventListener("DOMContentLoaded", () => {
        const filterPanelParent =
            document.getElementById("filter-panel")?.parentElement;
        if (filterPanelParent) {
            observer.observe(filterPanelParent, {
                attributes: true,
                attributeFilter: ["class"],
            });
        }
    });

    function clearFilters() {
        // Clear all filter inputs
        document.getElementById("filter-sender").value = "";
        document.getElementById("filter-recipient").value = "";
        document.getElementById("filter-date-from").value = "";
        document.getElementById("filter-date-to").value = "";
        document.getElementById("filter-has-attachments").checked = false;

        // Trigger search with cleared filters
        document
            .getElementById("search-input")
            .dispatchEvent(new Event("search"));
    }

    // Show active filters as badges
    function updateActiveFilters() {
        const container = document.getElementById("active-filters");
        container.innerHTML = "";

        const sender = document.getElementById("filter-sender").value;
        const recipient = document.getElementById("filter-recipient").value;
        const dateFrom = document.getElementById("filter-date-from").value;
        const dateTo = document.getElementById("filter-date-to").value;
        const hasAttachments = document.getElementById(
            "filter-has-attachments",
        ).checked;

        if (sender) {
            addFilterBadge(container, "Sender: " + sender, "sender");
        }
        if (recipient) {
            addFilterBadge(container, "Recipient: " + recipient, "recipient");
        }
        if (dateFrom) {
            addFilterBadge(container, "From: " + dateFrom, "date_from");
        }
        if (dateTo) {
            addFilterBadge(container, "To: " + dateTo, "date_to");
        }
        if (hasAttachments) {
            addFilterBadge(container, "Has Attachments", "has_attachments");
        }
    }

    function addFilterBadge(container, text, filterName) {
        const badge = document.createElement("span");
        badge.className =
            "inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-blue-100 text-blue-800";
        badge.innerHTML =
            text +
            " <button onclick=\"removeFilter('" +
            filterName +
            '\')" class="ml-2 text-blue-600 hover:text-blue-800">&times;</button>';
        container.appendChild(badge);
    }

    function removeFilter(filterName) {
        if (filterName === "sender") {
            document.getElementById("filter-sender").value = "";
        } else if (filterName === "recipient") {
            document.getElementById("filter-recipient").value = "";
        } else if (filterName === "date_from") {
            document.getElementById("filter-date-from").value = "";
        } else if (filterName === "date_to") {
            document.getElementById("filter-date-to").value = "";
        } else if (filterName === "has_attachments") {
            document.getElementById("filter-has-attachments").checked = false;
        }

        // Trigger search
        document
            .getElementById("search-input")
            .dispatchEvent(new Event("search"));
    }

    // Update active filters on any change
    document.addEventListener("htmx:afterRequest", updateActiveFilters);
</script>
{{end}}
